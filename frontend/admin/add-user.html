<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add User</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

</head>

<body>
    <header class="user-header">
            <a href="home.html" class="to_the_main"><div class="logo"><img src="../images/logo.png" alt="" class="pic_logo"></div></a>
            
            <div class="bell-menu">
                <!-- Bell Image link (https://www.google.com/url?sa=i&url=https%3A%2F%2Ficones.pro%2Fen%2Fpink-notification-bell-icon-png-symbol%2F&psig=AOvVaw3wDQe_UEJ1ORQ8DEZl_sjQ&ust=1745994682173000&source=images&cd=vfe&opi=89978449&ved=0CBgQjhxqFwoTCKi-9ZzP_IwDFQAAAAAdAAAAABAK) -->
                <a href="notifications.html" class="bell-div"><div class="bell-image"><img src="../images/bell.png" alt="" class="pic_logo"></div></a>
            <!-- Menu function -->
            <div id="menuHamToggle">
                <!-- Create Hidden Checkbos, that will be used as Click Function-->
                <input type="checkbox">
    
                <!-- Lets create three line hamburger menu
                Can animate to display as ham menu and closing menu tag.
                -->
                <span></span>
                <span></span>
                <span></span>
    
                <!-- Here menu goes -->
                <ul id="mainMenu">
                    <a href="profile.html"> <li> Profile </li></a>
                    <a href="user-management.html"> <li> User Management </li></a>
                    <a href="consultant-verification.html"> <li> Consultant Verification </li></a>
                    <a href="support-tickets.html"> <li> Support Tickets </li></a>
                    <a href="email-announcement.html"> <li> Email Announcement </li></a>
                    <a href="settings.html"> <li> Settings</li></a>
                    <a href="#" onclick="showSignOutModal()"> <li> Sign Out </li></a>
                </ul>
            </div>
            <!-- Menu function END -->
            </div>
 
    </header>
    
    
<!-- Sign Out Confirmation Modal -->
<div id="signOutModal" class="modal-overlay">
  <div class="modal-content">
    <p>Are you sure you want to sign out?</p>
    <div class="modal-buttons">
      <button onclick="confirmSignOut()">Yes</button>
      <button onclick="closeModal()">No</button>
    </div>
  </div>
</div>
    <!-- Logic -->
    


<!-- Modal Window -->
  <div  class="add-user_modal">
  <div class="modal-content_add">
  <h2 class="form-title">Add User Form</h2>
  <form class="user-form" id="addUserForm">
    <div class="form-row">
      <label for="name">Name:</label>
        <input type="text" class="name_input" id="name" placeholder="Enter your name" />
    </div>
    <div class="form-row">
      <label for="surname">Surname:</label>
        <input type="text" id="surname" class="name_input" placeholder="Enter your surname" />
    </div>
    <div class="form-row">
      <label for="email-id">Email:</label>
        <input type="email" id="email-id" placeholder="Enter email" oninput="checker()" >
        <div id="icon">
        </div>
        <p id="error-msg">Please Enter A Valid Email</p>
    </div>
    <div class="form-row">
      <label class="label_repeat_add-user" for="password-id">Password:</label>
        <div class="password-wrapper_add-user">
         <input type="password" class="password_class" id="password-id" placeholder="Enter Password">
          <i class="fas fa-eye toggle-password" toggle="#password-id"></i>
        </div>
    </div>
    <div class="form-row">
      <label class="label_repeat_add-user" for="repeat">Repeat:</label>
        <div class="password-wrapper_add-user">
          <input type="password" id="repeat" class="password_class" placeholder="Repeat your password">
          <i class="fas fa-eye toggle-password" toggle="#repeat"></i>
        </div>
    </div>
    <div class="form-row">
      <label for="birthday">Date of Birth:</label>
      <input type="date" class="name_input" name="birthday" id="birthday">
    </div>
    <div id="birthdayWarning">
     You must be at least 18 years old to create an account.
    </div>

    <div class="form-row">
      <label>Gender:</label>
      <select class="select_add-user" id="gender">
        <option>Select</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>
    </div>
    <div class="form-row">
      <label>Country:</label>
      <select class="select_add-user" id="country">
        <option>Select</option>
        <option>Germany</option>
        <option>USA</option>
        <option>Turkey</option>
      </select>
    </div>
    <div class="form-row">
      <label for="city">City:</label>
        <input type="text" id="city" class="name_input" placeholder="Enter city" />
    </div>
    <div class="form-row">
      <label>Role:</label>
      <select class="select_add-user" id="role">
        <option>Select</option>
        <option>Student</option>
        <option>Consultant</option>
        <option>Admin</option>
      </select>
    </div>
    <input type="hidden" id="status" value="active" />

    <div class="form-buttons">
      <button type="submit" class="edit-btn" id="submitBtn" disabled>+ Create User</button>
      <button type="button" class="return_btn" onclick="goBack()">âœ– Go Back</button>
    </div>
  </form>
</div>

  </div>

      
        
    
  
    <footer>
        <div>
            <div class="footer-logo"><img src="../images/logo.png" alt="" class="pic_logo"></div>
            <div class="social-icons">
                <a href="" class="twitter_link">
                    <img src="../images/twitter.png" alt="X">
                </a>
                <a href="" class="twitter_link">
                    <img src="../images/instagram.png" alt="Instagram">
                </a>
                <a href="" class="twitter_link1">
                    <img src="../images/youtube.png" alt="YouTube">
                </a>
                <a href="" class="twitter_link">
                    <img src="../images/linkedin.png" alt="LinkedIn">
                </a>
            </div>
        </div>
        <div class="footer-links">
            <h4 class="h4_service">Service & Contacts</h4>
            <a href="../faq.html" class="class_footer">
                <p>FAQ</p> 
            </a>
            <a href="../contact-us.html" class="class_footer">
                <p>Contact Us</p> 
            </a>
            <a href="../privacy-policy.html" class="class_footer">
                <p>Privacy Policy</p> 
            </a>
            <a href="../about-us.html" class="class_footer">
                <p>About Us</p>
            </a>
            <a href="../terms-conditions.html" class="class_footer">
              <p>Terms and Conditions</p>
          </a>
        </div>
    </footer>

  <script src="../auth.js"></script>
  <script src="../script.js"></script>     
    
<script>
  (async () => {
    if (typeof autoEnforceRoleFromPath === 'function') {
      await autoEnforceRoleFromPath();
    }
  })();

  // Email validation function
  function checker() {
    const emailId = document.getElementById("email-id");
    const errorMsg = document.getElementById("error-msg");
    const icon = document.getElementById("icon");
    const mailRegex = /^[a-zA-Z][a-zA-Z0-9\-\_\.]+@[a-zA-Z0-9]{2,}\.[a-zA-Z0-9]{2,}$/;

    icon.style.display = "none";
    if (emailId.value.match(mailRegex)) {
      icon.innerHTML = '<i class="fas fa-check-circle"></i>';
      icon.style.color = '#2ecc71';
      errorMsg.style.display = 'none';
      emailId.style.border = '2px solid #2ecc71';
    } else if (emailId.value === "") {
      icon.style.display = 'none';
      errorMsg.style.display = 'none';
      emailId.style.border = '2px solid #d1d3d4';
    } else {
      icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
      icon.style.color = '#ff2851';
      errorMsg.style.display = 'block';
      emailId.style.border = '2px solid #ff2851';
    }
  }

  // Birthday / age validation
  document.getElementById('birthday').addEventListener('input', function () {
    const birthday = new Date(this.value);
    const today = new Date();
    const age = today.getFullYear() - birthday.getFullYear();
    const isOldEnough = age > 18 || (age === 18 && (
      today.getMonth() > birthday.getMonth() ||
      (today.getMonth() === birthday.getMonth() && today.getDate() >= birthday.getDate())
    ));

    const warning = document.getElementById('birthdayWarning');
    const submitBtn = document.getElementById('submitBtn');

    if (!isOldEnough) {
      warning.style.display = 'block';
      submitBtn.disabled = true;
    } else {
      warning.style.display = 'none';
      submitBtn.disabled = false;
    }
  });

  // Handle user creation via backend API
  document.getElementById('addUserForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const name = document.getElementById('name').value.trim();
    const surname = document.getElementById('surname').value.trim();
    const email = document.getElementById('email-id').value.trim();
    const password = document.getElementById('password-id').value;
    const repeat = document.getElementById('repeat').value;
    const birthday = document.getElementById('birthday').value;
    const gender = document.getElementById('gender').value.toLowerCase();
    const country = document.getElementById('country').value;
    const city = document.getElementById('city').value.trim();
    const role = document.getElementById('role').value.toLowerCase();
    const access_level = role === "admin" ? "super" : "standard";

    if (!name || !surname || !email || !password) {
      alert("Please complete all required fields.");
      return;
    }
    if (password !== repeat) {
      alert("Passwords do not match.");
      return;
    }
    if (gender === "select") {
      alert("Please select a gender.");
      return;
    }
    if (country === "Select") {
      alert("Please select a country.");
      return;
    }
    if (role === "select") {
      alert("Please select a role.");
      return;
    }

    const userPayload = {
      name,
      surname,
      email,
      password,
      birthday,
      gender,
      country_name: country,
      city,
      role,
      access_level,
      languages: [],
      profile_picture: ""
    };

    try {
      const token = sessionStorage.getItem("accessToken");

const response = await fetch("http://localhost:8000/admin/users", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Authorization": "Bearer " + sessionStorage.getItem("accessToken")
  },
  body: JSON.stringify(userPayload)
});




      if (response.ok) {
  const data = await response.json();

  // Optional: store token for testing purposes
  localStorage.setItem("access_token", data.access_token);

  alert("User created successfully!");
  window.location.href = 'user-management.html';
} else {
  const error = await response.json();
  alert("Error: " + (error.detail || "Something went wrong."));
}

    } catch (err) {
      alert("Network error: " + err.message);
    }
  });

  // Go Back button handler
  function goBack() {
    window.history.back();
  }
</script>



    </body>
</html>