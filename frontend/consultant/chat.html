<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
  <link rel="icon" type="image/png" href="../images/favicon.png">
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

</head>

<body>
  <header class="user-header">
    <a href="home.html" class="to_the_main">
      <div class="logo"><img src="../images/logo.png" alt="" class="pic_logo"></div>
    </a>

    <div class="bell-menu">
      <a href="notifications.html" class="bell-div notif-bell-wrapper">
        <i class="far fa-bell bell-icon">
          <span id="notifBadge" class="notification-badge"></span>
        </i>
      </a>

      <div id="menuHamToggle">

        <input type="checkbox">


        <span></span>
        <span></span>
        <span></span>


        <ul id="mainMenu">
          <a href="profile.html">
            <li> Profile </li>
          </a>
          <a href="appointments.html">
            <li> Appointments </li>
          </a>
          <a href="messages.html">
            <li> Messages </li>
          </a>
          <a href="consultancy-areas.html">
            <li> Consultancy Areas </li>
          </a>
          <a href="timetable.html">
            <li> Timetable </li>
          </a>
          <a href="support-tickets.html">
            <li> Support Tickets </li>
          </a>
          <a href="settings.html">
            <li> Settings </li>
          </a>
          <a href="#" onclick="showSignOutModal()">
            <li> Sign Out </li>
          </a>
        </ul>
      </div>

    </div>

  </header>

  <div id="signOutModal" class="modal-overlay">
    <div class="modal-content">
      <p>Are you sure you want to sign out?</p>
      <div class="modal-buttons">
        <button onclick="confirmSignOut()">Yes</button>
        <button onclick="closeModal()">No</button>
      </div>
    </div>
  </div>


  <section class="chat-conversation-section">


    <div class="chat-header">
      <button class="back-button" onclick="goBackToInbox()">‚Üê Back to Messages</button>
      <div class="consultant-info">
        <img src="../images/avatar.png" alt="User" class="avatar">
        <a href="#" class="partner-name">User</a>
      </div>

    </div>


    <div class="chat-messages" id="chatMessages">

    </div>


    <div class="chat-input">
      <textarea id="messageInput" placeholder="Type a message..."></textarea>
      <button id="sendBtn">Send</button>
    </div>

  </section>


  <div id="reportModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-button" onclick="closeReportModal()">&times;</span>
      <h2>Why would you like to report this person?</h2>
      <textarea id="reportReason" rows="8" maxlength="2500"
        placeholder="Please explain the reason for your report (max 500 words)..."></textarea>
      <button onclick="submitReport()">Submit Report</button>
    </div>
  </div>


  <footer>
<div class="logo_icons">
  <div class="footer-logo">
    <img src="../images/logo.png" alt="" class="pic_logo">
  </div>
  <p class="follow-text">Follow us!</p>
  <div class="social-icons">
    <a href="http://www.instagram.com/easyabroad_" target="_blank">
      <img src="../images/instagram.png" alt="Instagram">
    </a>
  </div>
</div>
  <div class="footer-links">
      <h4 class="h4_service">Service & Contacts</h4>
      <a href="../faq.html" class="class_footer"><p>FAQ</p></a>
      <a href="../contact-us.html" class="class_footer"><p>Contact Us</p></a>
      <a href="../support-us.html" class="class_footer"><p>Support Us</p></a>
      <a href="../about-us.html" class="class_footer"><p>About Us</p></a>
      <a href="../privacy-policy.html" class="class_footer"><p>Privacy Policy</p></a>
      <a href="../terms-conditions.html" class="class_footer"><p>Terms and Conditions</p></a>
  </div>
</footer>  <script src="../auth.js"></script>
  <script src="../script.js"></script>
  <script>
(async () => {
  await autoEnforceRoleFromPath();            // from auth.js
  const token = localStorage.getItem("accessToken");
  const params = new URLSearchParams(window.location.search);
  const partnerHash = params.get("partnerId");
  if (!partnerHash) {
    await showInAppAlert("No conversation selected.", () => window.location.href="messages.html");
    return;
  }

  let partnerIdNumeric;

  // 1) Load partner info (name/avatar) + numeric ID
  async function loadPartnerInfo() {
    try {
      const res = await fetch(`http://localhost:8000/users/by-hash/${partnerHash}`, {
        headers: {"Authorization": `Bearer ${token}`}
      });
      if (!res.ok) throw new Error();
      const u = await res.json();
      partnerIdNumeric = u.id;
      document.querySelector(".partner-name").textContent =
        `${u.first_name} ${u.last_name}`.trim() || u.full_name;
      document.querySelector(".avatar").src = 
        u.profile_picture
          ? "http://localhost:8000" + u.profile_picture
          : "../images/avatar.png";
    } catch {
      document.querySelector(".partner-name").textContent = `User #${partnerHash}`;
    }
  }
  await loadPartnerInfo();

  // 2) Load and render thread
  async function loadThread() {
    try {
      const res = await fetch(`http://localhost:8000/messages/with/${partnerHash}`, {
        headers: {"Authorization": `Bearer ${token}`}
      });
      if (!res.ok) throw new Error();
      const msgs = await res.json();
      renderChat(msgs);
    } catch {
      await showInAppAlert("Failed to load chat messages.");
    }
  }

  function renderChat(messages) {
    const c = document.getElementById("chatMessages");
    c.innerHTML = "";
    messages.forEach(m => {
      const bubble = document.createElement("div");
      bubble.className = "message-bubble " + (m.from_me ? "me" : "partner");
      bubble.innerHTML = `
        <div class="bubble-content">
          <p>${m.message}</p>
          <span class="timestamp">
            ${new Date(m.sent_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}
          </span>
        </div>`;
      c.appendChild(bubble);
    });
    c.scrollTop = c.scrollHeight;
  }

  // 3) Send a new message
  async function sendMessage() {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if (!text) return;
    if (text.length > 500) {
      await showInAppAlert("Message cannot exceed 500 characters.");
      return;
    }
    const userId = JSON.parse(atob(token.split(".")[1])).sub;
    if (partnerIdNumeric === userId) {
      await showInAppAlert("üö´ You cannot message yourself.");
      return;
    }

    const payload = {
      receiver_id: partnerIdNumeric,
      message: text,
      booking_id: null
    };
    try {
      const res = await fetch("http://localhost:8000/messages/send", {
        method:"POST",
        headers: {
          "Content-Type":"application/json",
          "Authorization":`Bearer ${token}`
        },
        body:JSON.stringify(payload)
      });
      if (!res.ok) {
        const err = await res.text();
        await showInAppAlert("Failed to send message: " + err);
        return;
      }
      input.value = "";
      await loadThread();
    } catch {
      await showInAppAlert("Network error sending message.");
    }
  }

  document.getElementById("sendBtn").onclick = sendMessage;
  document.getElementById("messageInput").onkeydown = e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  };

  window.goBackToInbox = () => window.location.href = "messages.html";
  await loadThread();
  setInterval(loadThread, 3000);
})();
  </script>



  <div id="inAppModal" class="modal-overlay">
    <div class="modal-content">
      <p id="modalMessage">Message here</p>
      <div id="modalButtons" class="modal-buttons">
        <button id="modalConfirmButton" style="display: none;">OK</button>
        <button id="modalCancelButton" style="display: none;">Cancel</button>
      </div>
    </div>
  </div>
</body>

</html>