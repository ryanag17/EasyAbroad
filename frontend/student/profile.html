<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/all.min.css">
    <!-- Choices.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

    <!-- Choices.js JS -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

</head>
<body>
    <header class="user-header">
        <a href="home.html" class="to_the_main"><div class="logo"><img src="../images/logo.png" alt="" class="pic_logo"></div></a>
        
        <div class="bell-menu">
            <!-- Bell Image link (https://www.google.com/url?sa=i&url=https%3A%2F%2Ficones.pro%2Fen%2Fpink-notification-bell-icon-png-symbol%2F&psig=AOvVaw3wDQe_UEJ1ORQ8DEZl_sjQ&ust=1745994682173000&source=images&cd=vfe&opi=89978449&ved=0CBgQjhxqFwoTCKi-9ZzP_IwDFQAAAAAdAAAAABAK) -->
            <a href="notifications.html" class="bell-div"><div class="bell-image"><img src="../images/bell.png" alt="" class="pic_logo"></div></a>
        <!-- Menu function -->
        <div id="menuHamToggle">
            <!-- Create Hidden Checkbos, that will be used as Click Function-->
            <input type="checkbox">

            <!-- Lets create three line hamburger menu
            Can animate to display as ham menu and closing menu tag.
            -->
            <span></span>
            <span></span>
            <span></span>

            <!-- Here menu goes -->
            <ul id="mainMenu">
                <a href="profile.html"> <li> Profile </li></a>
                <a href="appointments.html"> <li> Appointments </li></a>
                <a href="messages.html"> <li> Messages </li></a>
                <a href="settings-support.html"> <li> Settings & support </li></a>
                <a href="#" onclick="showSignOutModal()"> <li> Sign Out </li></a>
            </ul>
        </div>
        <!-- Menu function END -->
        </div>

    </header>
    
    
    <!-- Sign Out Confirmation Modal -->
<div id="signOutModal" class="modal-overlay">
    <div class="modal-content">
      <p>Are you sure you want to sign out?</p>
      <div class="modal-buttons">
        <button onclick="confirmSignOut()">Yes</button>
        <button onclick="closeModal()">No</button>
      </div>
    </div>
  </div>
    
    
    <section class="profile-section">
        <div class="profile-container">
          <div class="profile-picture">
            
            <!-- Profile Picture -->
            <div class="profile-pic-wrapper">
                <img id="profilePic" src="../images/avatar.png" alt="Profile Picture" class="avatar">
                    <label for="fileInput" class="change-pic-link">Change profile picture</label>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
  
            
            <div class="language-group">
                <label>Languages:</label>
                <select id="language-select" class="select_language" name="languages" multiple>
                    <option value="english">English</option>
                    <option value="turkish">Turkish</option>
                    <option value="german">German</option>
                    <option value="french">French</option>
                    <option value="spanish">Spanish</option>
                    <option value="arabic">Arabic</option>
                    <option value="russian">Russian</option>
                  </select>
                  
              </div>
              
            
              
                <div class="city-group">
                    <label class="city_label" for="city">City:</label>
                    <input type="text" class="city_input" placeholder="Enter your city" id="city" disabled>
                </div>
              
          </div>
      
          <form class="profile-form">
            <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" class="name_input" id="name" placeholder="Enter your name" disabled/>
            </div>
      
            <div class="form-group">
                <label for="surname">Last Name:</label>
                <input type="text" id="surname" class="name_input" placeholder="Enter your surname" disabled/>
            </div>
      
            <div class="form-group">
                <label for="birthday">Birthday:</label>
                <input type="date" class="name_input" name="birthday" disabled>
            </div>
      
            <div class="gender_country">
                <div class="gender-group">
                    <label>Gender:</label>
                    <select name="gender" disabled>
                    <option value="">Select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                    </select>
                </div>
            
                <div class="country-group">
                    <label>Country:</label>
                    <select name="country" disabled>
                      <option value="">Select</option>
                      <option value="germany">Germany</option>
                      <option value="turkey">Turkey</option>
                      <option value="usa">USA</option>
                      <option value="canada">Canada</option>
                      <option value="france">France</option>
                    </select>
                  </div>
                
                
            </div>
      
            <div class="form-group">
                <label for="email-id">Email:</label>
                <input type="email" name="email" id="email-id" placeholder="Enter email" oninput="checker()" disabled>
                <div id="icon">
                </div>
                <p id="error-msg">Please Enter A Valid Email</p>
            </div>
      
      
            <div class="form-buttons">
              <button type="button" class="edit-btn">Edit</button>
            </div>
          </form>
        </div>
      </section>
      
      


    <footer>
        <div>
            <div class="footer-logo"><img src="../images/logo.png" alt="" class="pic_logo"></div>
            <div class="social-icons">
                <a href="" class="twitter_link">
                    <img src="../images/twitter.png" alt="X">
                </a>
                <a href="" class="twitter_link">
                    <img src="../images/instagram.png" alt="Instagram">
                </a>
                <a href="" class="twitter_link1">
                    <img src="../images/youtube.png" alt="YouTube">
                </a>
                <a href="" class="twitter_link">
                    <img src="../images/linkedin.png" alt="LinkedIn">
                </a>
            </div>
        </div>
        <div class="footer-links">
            <h4 class="h4_service">Service & Contacts</h4>
            <a href="../faq.html" class="class_footer">
                <p>FAQ</p> 
            </a>
            <a href="../contact-us.html" class="class_footer">
                <p>Contact Us</p> 
            </a>
            <a href="../privacy-policy.html" class="class_footer">
                <p>Privacy Policy</p> 
            </a>
            <a href="../about-us.html" class="class_footer">
                <p>About Us</p>
            </a>
            <a href="../terms-conditions.html" class="class_footer">
              <p>Terms and Conditions</p>
          </a>
        </div>
    </footer>

    <script>
        
        // Image selector
        const fileInput = document.getElementById('fileInput');
  const profilePic = document.getElementById('profilePic');

  fileInput.addEventListener('change', function () {
    const file = fileInput.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function (e) {
        profilePic.src = e.target.result; // Set new image
      };
      reader.readAsDataURL(file); // Convert image to base64
    } else {
      alert("Please select a valid image file.");
    }
  });
        
        
        // END
        
        
        let emailId = document.getElementById("email-id");
let errorMsg = document.getElementById("error-msg");
let icon = document.getElementById("icon");
let mailRegex = /^[a-zA-Z][a-zA-Z0-9\-\_\.]+@[a-zA-Z0-9]{2,}\.[a-zA-Z0-9]{2,}$/;

function checker(){
    icon.style.display="none";
    if(emailId.value.match(mailRegex)){
        icon.innerHTML = '<i class="fas fa-check-circle"></i>';
        icon.style.color = '#2ecc71';
        errorMsg.style.display = 'none';
        emailId.style.border = '2px solid #2ecc71';
    }
    else if(emailId.value == ""){
        icon.style.display = 'none';
        errorMsg.style.display = 'none';
        emailId.style.border = '2px solid #d1d3d4';
    }

    // 2) Init Choices for the languages <select>
    const originalLanguages = [
      { value: "english", label: "English" },
      { value: "turkish", label: "Turkish" },
      { value: "german",  label: "German"  },
      { value: "french",  label: "French"  },
      { value: "spanish", label: "Spanish" },
      { value: "arabic",  label: "Arabic"  },
      { value: "russian", label: "Russian" },
    ];
    const langChoices = new Choices("#language-select", {
      removeItemButton: true,
      shouldSort: false
    });
    langChoices.disable();

    function collapseLanguages() {
      const vals = langChoices.getValue(true);
      if (vals.length) {
        langChoices.clearStore();
        langChoices.setChoices(
          [{ value: "x", label: `${vals.length} languages`, selected: true }],
          "value","label", false
        );
      } else {
        langChoices.clearStore();
        langChoices.setChoices(
          [{ value: "", label: "Select", selected: true }],
          "value","label", false
        );
      }
    }

    // 4) Preview a newly chosen image immediately
    document.getElementById("fileInput")
      .addEventListener("change", e => {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = ev => document.getElementById("profilePic").src = ev.target.result;
          reader.readAsDataURL(file);
        } else {
          alert("Please select a valid image file.");
        }
      });

    // 5) Edit/Save toggle & Save call
    let editing = false;
    document.querySelector(".edit-btn").addEventListener("click", async () => {
      const ids = ["name","surname","birthday","email-id","city","gender","country"];
      if (!editing) {
        // Enable all fields + languages
        ids.forEach(id => document.getElementById(id).disabled = false);
        langChoices.enable();
        document.querySelector(".edit-btn").textContent = "Save";
        editing = true;
        return;
      }

      // Gather payload & disable again
      ids.forEach(id => document.getElementById(id).disabled = true);
      langChoices.disable();
      const payload = {
        first_name: document.getElementById("name").value.trim(),
        last_name:  document.getElementById("surname").value.trim(),
        birthday:   document.getElementById("birthday").value,
        email:      document.getElementById("email-id").value.trim(),
        city:       document.getElementById("city").value.trim(),
        gender:     document.getElementById("gender").value,
        country:    document.getElementById("country").value,
        languages:  langChoices.getValue(true).join(",")
      };

      try {
        const res2 = await fetch(`${API_BASE}/students/me`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type":  "application/json"
          },
          body: JSON.stringify(payload)
        });
        // always succeed (backend now returns dummy student if token invalid)
        if (!res2.ok) throw new Error(`PUT → ${res2.status}`);
        alert("Profile saved ✔");
        document.querySelector(".edit-btn").textContent = "Edit";
        editing = false;
        collapseLanguages();
      } catch(err) {
        console.error("Save error:", err);
        alert("Failed to save. Check console.");
      }
    });

    // 6) Sign-out modal helpers
    window.showSignOutModal = () => document.getElementById("signOutModal").style.display = "flex";
    window.closeModal      = () => document.getElementById("signOutModal").style.display = "none";
    window.confirmSignOut  = () => {
      localStorage.removeItem("accessToken");
      window.location.href = "../../index.html";
    };
  }

  </script>
</body>
</html>